<!DOCTYPE HTML>
<html>
  <head>
    <link type="text/css" rel="stylesheet" href="microphone/microphone.min.css">
      <!-- Most Recent JQuery -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  </head>
  <body style="text-align: center;">
    <center><div id="microphone"></div></center>
    <pre id="result"></pre>
    <div id="info"></div>
    <div id="error"></div>
    <script src="microphone/microphone.min.js"></script>

    <script>
      var mic = new Wit.Microphone(document.getElementById("microphone"));
      var info = function (msg) {
        document.getElementById("info").innerHTML = msg;
      };
      var error = function (msg) {
        document.getElementById("error").innerHTML = msg;
      };
      mic.onready = function () {
        info("Microphone is ready to record");
      };
      mic.onaudiostart = function () {
        info("Recording started");
        error("");
      };
      mic.onaudioend = function () {
        info("Recording stopped, processing started");
      };
      mic.onresult = function (intent, entities) {
        var r = kv("intent", intent);
        var loc = null;
        for (var k in entities) {
          var e = entities[k];

          if (!(e instanceof Array)) {
            r += kv(k, e.value);
            if(k == "location"){
                  loc = e.value;
              }
              else if(k == "intent"){
                  if(e.value == "weather"){
                      getWeather(loc);
                  }
              }
            console.log(e.value);
          } else {
            for (var i = 0; i < e.length; i++) {
              r += kv(k, e[i].value);
              console.log("loop");
            }
          }
        }
        document.getElementById("result").innerHTML = r;
      };
      mic.onerror = function (err) {
        error("Error: " + err);
      };
      mic.onconnecting = function () {
        info("Microphone is connecting");
      };
      mic.ondisconnected = function () {
        info("Microphone is not connected");
      };

      mic.connect("Y2XBXF7UMMARWZRXXD7ML3X3JWS5ZDBP");
      // mic.start();
      // mic.stop();
    loadVoices();
    window.speechSynthesis.onvoiceschanged = function(e) {
            loadVoices();
    };
    function loadVoices() {
        // Fetch the available voices.
        var voices = speechSynthesis.getVoices();
    }
    function speak(text) {
      // Create a new instance of SpeechSynthesisUtterance.
        var msg = new SpeechSynthesisUtterance();

      // Set the text.
        msg.text = text;
      // Set the attributes.
        msg.volume = 1; // 0 to 1
        msg.rate = 0.9; // 0.1 to 10
        msg.pitch = 1; //0 to 2
        msg.voice = speechSynthesis.getVoices().filter(function(voice) { return voice.name == "Google UK English Male"; })[0];

      // Queue this utterance.
        window.speechSynthesis.speak(msg);
    }
    function forecastFor(apiRes) {
      return fahrenheit(Number(apiRes.main.temp)).toString()+" degrees, and "+(apiRes.weather[0].description);
    }

    function fahrenheit(kelvin) {
      return Math.round(kelvin * 9/5 - 459.67);
    }

    function getWeather(loc) {
      if(!loc || loc.localeCompare("outside") == 0){
          $.ajax({
              url: "http://api.openweathermap.org/data/2.5/weather?lat=39.68&lon=-75.75&appid=3951f22e495bc32a769fdd57d9b9f375"
         }).done(function(data) {
                  var weather = forecastFor(data);
                  console.log(weather);
                  speak("Sir, it is "+weather+" in Newark");
                  info(data);
         }).fail(function(jqXHR, textStatus) {
            alert( "Request failed: " + textStatus );
        });
      }
      else{
          var weatherLink = "http://api.openweathermap.org/data/2.5/weather?q="+loc+"&appid=3951f22e495bc32a769fdd57d9b9f375";
          $.ajax({
              url: weatherLink
         }).done(function(data) {
                  var weather = forecastFor(data);
                  console.log(weather);
                  speak("Sir, it is "+weather+" in "+loc);
                  info(data);
         }).fail(function(jqXHR, textStatus) {
            alert( "Request failed: " + textStatus );
        });
      
      }
    }

      function kv (k, v) {
        if (toString.call(v) !== "[object String]") {
          v = JSON.stringify(v);
        }
        return k + "=" + v + "\n";
      }
    </script>
  </body>
  </html>